<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Каталог дверей</title>
  <style>
    :root{
      --bg:#0b1220; --muted:#9db0d0; --text:#eef3ff;
      --accent:#6aa3ff; --danger:#ff5a6a; --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(106,163,255,.35), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(51,212,157,.25), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    header{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin-bottom:14px;}
    .title h1{margin:0; font-size:20px; letter-spacing:.2px; user-select:none;}
    .title .subtitle{margin:6px 0 0; font-size:13px; color:var(--muted); line-height:1.3}
    .callBtn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background: rgba(106,163,255,.18);
      color: var(--text); text-decoration:none; font-weight:950; box-shadow: inset 0 0 0 1px rgba(106,163,255,.35);
    }
    .callBtn:active{transform:translateY(1px)}
    .callBtn small{opacity:.85; font-weight:800}
    .callBtn .dot{width:8px; height:8px; border-radius:999px; background: rgba(51,212,157,.9); box-shadow:0 0 0 4px rgba(51,212,157,.15)}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center; background: rgba(255,255,255,.03); border:1px solid var(--border); padding:8px; border-radius:999px;}
    .tab{border:0; cursor:pointer; padding:10px 14px; border-radius:999px; background:transparent; color:var(--muted); font-weight:700;}
    .tab.active{background: rgba(106,163,255,.18); color:var(--text); box-shadow: inset 0 0 0 1px rgba(106,163,255,.35);}

    .panel{background: rgba(255,255,255,.03); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow: var(--shadow); width:100%;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    label{font-size:12px; color:var(--muted)}
    input{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background: rgba(0,0,0,.18); color: var(--text); outline:none;}

    .btn{border:0; cursor:pointer; padding:10px 12px; border-radius:12px; background: rgba(106,163,255,.18); color: var(--text); font-weight:800; box-shadow: inset 0 0 0 1px rgba(106,163,255,.35); white-space:nowrap;}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background: rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,.10); color: var(--text); font-weight:750;}
    .btn.danger{background: rgba(255,90,106,.16); box-shadow: inset 0 0 0 1px rgba(255,90,106,.35);}

    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:14px 0 10px;}
    .badge{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.03); color:var(--muted); font-size:12px;}
    .search{display:flex; gap:10px; align-items:center; flex:1; justify-content:flex-end; min-width:260px;}

    .grid{display:grid; gap:var(--gap); grid-template-columns: repeat(4, minmax(0, 1fr)); margin-top:12px;}
    .card{background: rgba(255,255,255,.03); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow: var(--shadow); display:flex; flex-direction:column; min-height:220px; cursor:pointer;}
    .card.selected{border-color: rgba(106,163,255,.55); box-shadow: 0 0 0 2px rgba(106,163,255,.22), var(--shadow);}

    .hidden{display:none!important}

    .img{position:relative; aspect-ratio:4/3; background:
        linear-gradient(135deg, rgba(106,163,255,.35), rgba(51,212,157,.20)),
        radial-gradient(500px 250px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        rgba(0,0,0,.15);
      padding:10px; border-bottom:1px solid var(--border); overflow:hidden;}
    .img img.photo{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; z-index:1;}
    .pill{font-size:11px; padding:6px 8px; border-radius:999px; background: rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.12); color:var(--text);}
    .img .overlay{position:relative; z-index:2; width:100%; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; height:100%;}

    .img .gallery-controls{position:absolute; left:10px; right:10px; top:10px; z-index:3; display:flex; justify-content:space-between; pointer-events:none;}
    .img .gbtn{pointer-events:auto; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.30); color: var(--text); border-radius:999px; padding:6px 10px; font-weight:900; cursor:pointer;}
    .img .dots{position:absolute; left:0; right:0; bottom:8px; z-index:3; display:flex; gap:6px; justify-content:center; pointer-events:none;}
    .img .dot{width:7px; height:7px; border-radius:999px; background: rgba(255,255,255,.35); border:1px solid rgba(0,0,0,.25);}
    .img .dot.active{background: rgba(255,255,255,.85);}

    /* Миниатюры внутри выбранной карточки */
    .in-card-thumbs{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border); overflow:auto; background: rgba(0,0,0,.10)}
    .in-card-thumbs::-webkit-scrollbar{height:8px}
    .in-card-thumbs::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10); border-radius:999px}
    .in-thumb{flex:0 0 auto; width:56px; height:56px; border-radius:12px; border:1px solid rgba(255,255,255,.10); overflow:hidden; background: rgba(0,0,0,.2)}
    .in-thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .in-thumb.active{border-color: rgba(106,163,255,.7); box-shadow: 0 0 0 2px rgba(106,163,255,.20)}

    .content{padding:12px; display:flex; flex-direction:column; gap:8px; flex:1}
    .name{font-weight:900; line-height:1.25}
    .sub{color:var(--muted); font-size:12.5px; line-height:1.35}
    .desc{color:var(--muted); font-size:12.5px; line-height:1.35; flex:1}

    .price{font-weight:900; display:flex; flex-wrap:wrap; gap:8px; align-items:baseline}
    .price .old{color:var(--muted); text-decoration:line-through; font-weight:800; font-size:12.5px}
    .price .new{font-weight:950}
    .price .new:empty{display:none}
    .price .old:empty{display:none}

    /* Lightbox */
    .lightbox{position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,.78); display:flex; align-items:center; justify-content:center; padding:14px;}
    .lightbox.hidden{display:none}
    .lb-inner{width:min(1100px, 96vw); height:min(84vh, 760px); position:relative; border-radius:22px; overflow:hidden; border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(600px 300px at 20% 0%, rgba(106,163,255,.18), transparent 60%), rgba(10,16,30,.85);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .lb-img{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;}
    .lb-img img{max-width:100%; max-height:100%; border-radius:18px; box-shadow: 0 18px 50px rgba(0,0,0,.45);}
    .lb-top{position:absolute; left:12px; right:12px; top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; z-index:2;}
    .lb-chip{padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.35); color: var(--text); font-weight:850; font-size:12px;}
    .lb-btn{border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.35); color: var(--text); border-radius:999px; padding:10px 12px; cursor:pointer; font-weight:950;}
    .lb-nav{position:absolute; left:12px; right:12px; top:50%; transform:translateY(-50%); display:flex; justify-content:space-between; z-index:2; pointer-events:none;}
    .lb-nav .lb-btn{pointer-events:auto; padding:12px 14px;}
    .lb-thumbs{position:absolute; left:0; right:0; bottom:0; padding:10px; display:flex; gap:8px; overflow:auto; background: linear-gradient(to top, rgba(0,0,0,.55), transparent);
      z-index:2;
    }
    .lb-thumbs::-webkit-scrollbar{height:8px}
    .lb-thumbs::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:999px}
    .lb-t{flex:0 0 auto; width:56px; height:56px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); cursor:pointer}
    .lb-t img{width:100%; height:100%; object-fit:cover; display:block}
    .lb-t.active{border-color: rgba(106,163,255,.75); box-shadow: 0 0 0 2px rgba(106,163,255,.18)}

    @media (max-width:1000px){.grid{grid-template-columns: repeat(3, minmax(0, 1fr));}}
    @media (max-width:720px){.grid{grid-template-columns: repeat(2, minmax(0, 1fr));} header{gap:10px} .tabs{width:100%; justify-content:center} .title{width:100%} .lb-inner{height:82vh}}
    @media (max-width:420px){.grid{grid-template-columns: 1fr;} .lb-inner{height:86vh}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1 id="siteTitle">Каталог дверей</h1>
        <p class="subtitle">Консультация и запись на замер</p>
        <a class="callBtn" href="tel:89018099029" aria-label="Позвонить 8 901 809 9029">
          <span class="dot" aria-hidden="true"></span>
          Позвонить <small>8&nbsp;901&nbsp;809&nbsp;9029</small>
        </a>
      </div>

      <div class="tabs" role="tablist" aria-label="Вкладки каталога">
        <button class="tab active" data-tab="interior" role="tab" aria-selected="true">Межкомнатные</button>
        <button class="tab" data-tab="entrance" role="tab" aria-selected="false">Входные</button>
        <button class="btn secondary hidden" id="adminBtn" type="button" style="padding:10px 14px; border-radius:999px;">Войти как админ</button>
        <span class="badge hidden" id="adminBadge">Режим администратора</span>
      </div>
    </header>

    <div class="panel hidden" id="adminPanel">
      <!-- Админ-панель оставлена в коде, но в варианте №2 она скрыта -->
    </div>

    <div class="panel" id="publicSearchPanel" style="margin-top:12px;">
      <div class="meta" style="margin:0;">
        <div class="badge" id="countBadgePublic">Позиции: 0</div>
        <div class="search">
          <input id="searchPublic" placeholder="Поиск по модели/цвету/покрытию/описанию/цене..." />
        </div>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox hidden" aria-hidden="true">
    <div class="lb-inner" role="dialog" aria-modal="true" aria-label="Просмотр фото">
      <div class="lb-top">
        <div class="lb-chip" id="lbTitle">Фото</div>
        <button class="lb-btn" id="lbClose" type="button">✕</button>
      </div>
      <div class="lb-nav">
        <button class="lb-btn" id="lbPrev" type="button">‹</button>
        <button class="lb-btn" id="lbNext" type="button">›</button>
      </div>
      <div class="lb-img" id="lbImgArea">
        <img id="lbImg" alt="Фото" />
      </div>
      <div class="lb-thumbs" id="lbThumbs"></div>
    </div>
  </div>

  <script>
  // ====== НАСТРОЙКА: Google Sheets через OpenSheet ======
  var SHEET_ID = "1hhYlP9kbLOeUBtu2Amfe8Fs8py-yP_uXBKaqQU7bLwY";
  var SHEET_INTERIOR = "interior";
  var SHEET_ENTRANCE = "entrance";

  // ===== Совместимость =====
  if (!window.CSS) window.CSS = {};
  if (!CSS.escape) {
    CSS.escape = function (value) {
      // ВАЖНО: двойной слэш, чтобы строка стала "\$&" (иначе экранирование не работает корректно)
      return String(value).replace(/[^a-zA-Z0-9_\-]/g, "\\$&");
    };
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // ВАЖНО: без регэкспа, чтобы никогда не ломалось переносами строки.
  function parsePhotos(value) {
    if (!value) return [];
    var s = String(value);
    // заменяем переносы на запятые, затем сплит
    s = s.replace(/\r\n|\r|\n/g, ",");
    var parts = s.split(",");
    var out = [];
    for (var i = 0; i < parts.length; i++) {
      var u = (parts[i] || "").trim();
      if (!u) continue;
      out.push(u);
      if (out.length >= 5) break;
    }
    return out;
  }

  function toNumberSafe(v, fallback) {
    var n = parseFloat(String(v || "").replace(/[^0-9.\-]/g, ""));
    return isNaN(n) ? fallback : n;
  }

  function httpGetJson(url) {
  return fetch(url, { cache: "no-store" })
    .then(function (r) {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    })
    .then(function (txt) {
      // Google gviz возвращает не чистый JSON, а обёртку.
      // Нужно вытащить JSON из строки.
      var start = txt.indexOf("{");
      var end = txt.lastIndexOf("}");
      if (start === -1 || end === -1) throw new Error("GVIZ parse error");
      var json = JSON.parse(txt.slice(start, end + 1));

      // превращаем таблицу в массив объектов по заголовкам
      var cols = json.table.cols.map(function (c) { return c.label; });
      var rows = json.table.rows;

      var out = [];
      for (var i = 0; i < rows.length; i++) {
        var obj = {};
        for (var j = 0; j < cols.length; j++) {
          var key = cols[j];
          var cell = rows[i].c[j];
          obj[key] = cell && cell.v != null ? String(cell.v) : "";
        }
        out.push(obj);
      }
      return out;
      });
    }
    return new Promise(function (resolve, reject) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) return;
        if (xhr.status >= 200 && xhr.status < 300) {
          try { resolve(JSON.parse(xhr.responseText)); } catch (e) { reject(e); }
        } else {
          reject(new Error("HTTP " + xhr.status));
        }
      };
      xhr.send(null);
    });
  }

  function sheetUrl(sheetName) {
  // Google Visualization API (работает стабильно во всех браузерах)
  // ВАЖНО: листы должны называться interior и entrance
  var base = "https://docs.google.com/spreadsheets/d/" + encodeURIComponent(SHEET_ID) + "/gviz/tq?";
  var tq = "tq=" + encodeURIComponent("select *");
  var gid = "";
  // если у вас разные gid, можно настроить, но проще оставить по названию листа через sheet=
  return base + "sheet=" + encodeURIComponent(sheetName) + "&" + tq;
  }

  // UI
  var tabsEl = document.querySelectorAll(".tab");
  var gridEl = document.getElementById("grid");
  var countBadgePublic = document.getElementById("countBadgePublic");
  var searchPublicEl = document.getElementById("searchPublic");

  // Hide admin UI (вариант №2)
  var adminBtn = document.getElementById("adminBtn");
  var adminBadge = document.getElementById("adminBadge");
  var adminPanel = document.getElementById("adminPanel");
  if (adminBtn) adminBtn.classList.add("hidden");
  if (adminBadge) adminBadge.classList.add("hidden");
  if (adminPanel) adminPanel.classList.add("hidden");

  // Lightbox
  var lightbox = document.getElementById("lightbox");
  var lbClose = document.getElementById("lbClose");
  var lbPrev = document.getElementById("lbPrev");
  var lbNext = document.getElementById("lbNext");
  var lbImg = document.getElementById("lbImg");
  var lbTitle = document.getElementById("lbTitle");
  var lbThumbs = document.getElementById("lbThumbs");
  var lbImgArea = document.getElementById("lbImgArea");

  var activeTab = "interior";
  var selectedCardId = null;

  var dataInterior = [];
  var dataEntrance = [];
  var isLoading = false;
  var loadError = "";

  var lbCardId = null;
  var lbIndex = 0;
  var lbTouchStartX = null;

  function getActiveList() {
    return activeTab === "interior" ? dataInterior : dataEntrance;
  }

  function getItemById(id) {
    var list = getActiveList();
    for (var i = 0; i < list.length; i++) if (list[i].id === id) return list[i];
    return null;
  }

  function getQuery() {
    return (searchPublicEl && searchPublicEl.value ? searchPublicEl.value : "").trim().toLowerCase();
  }

  function openLightbox(cardId, index) {
    var item = getItemById(cardId);
    if (!item || !item.images || !item.images.length) return;

    lbCardId = cardId;
    lbIndex = Math.max(0, Math.min(index || 0, item.images.length - 1));
    selectedCardId = cardId;

    lightbox.classList.remove("hidden");
    lightbox.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";

    render();
    renderLightbox();
  }

  function closeLightbox() {
    lightbox.classList.add("hidden");
    lightbox.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    lbCardId = null;
    lbIndex = 0;
  }

  function renderLightbox() {
    var item = lbCardId ? getItemById(lbCardId) : null;
    var imgs = item && item.images ? item.images : [];
    if (!imgs.length) {
      closeLightbox();
      return;
    }

    lbIndex = (lbIndex + imgs.length) % imgs.length;
    lbImg.src = imgs[lbIndex];
    lbImg.alt = (item && item.name ? item.name + " — фото " + (lbIndex + 1) : "Фото " + (lbIndex + 1));

    var meta = [];
    if (item && item.name) meta.push(item.name);
    if (item && item.color) meta.push(item.color);
    if (item && item.finish) meta.push(item.finish);
    var metaText = meta.length ? meta.join(" • ") : "Фото";

    lbTitle.textContent = metaText + " • " + (lbIndex + 1) + "/" + imgs.length;

    lbThumbs.innerHTML = "";
    for (var i = 0; i < imgs.length; i++) {
      (function (ii) {
        var t = document.createElement("div");
        t.className = "lb-t" + (ii === lbIndex ? " active" : "");
        t.innerHTML = '<img src="' + escapeHtml(imgs[ii]) + '" alt="">';
        t.addEventListener("click", function (e) {
          e.stopPropagation();
          lbIndex = ii;
          renderLightbox();
        });
        lbThumbs.appendChild(t);
      })(i);
    }

    lbPrev.style.visibility = imgs.length > 1 ? "visible" : "hidden";
    lbNext.style.visibility = imgs.length > 1 ? "visible" : "hidden";
  }

  function stepLightbox(dir) {
    var item = lbCardId ? getItemById(lbCardId) : null;
    var imgs = item && item.images ? item.images : [];
    if (imgs.length < 2) return;
    lbIndex = (lbIndex + dir + imgs.length) % imgs.length;
    renderLightbox();
  }

  lbClose.addEventListener("click", function (e) { e.stopPropagation(); closeLightbox(); });
  lbPrev.addEventListener("click", function (e) { e.stopPropagation(); stepLightbox(-1); });
  lbNext.addEventListener("click", function (e) { e.stopPropagation(); stepLightbox(+1); });
  lightbox.addEventListener("click", function () { closeLightbox(); });
  document.querySelector(".lb-inner").addEventListener("click", function (e) { e.stopPropagation(); });

  document.addEventListener("keydown", function (e) {
    if (lightbox.classList.contains("hidden")) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowLeft") stepLightbox(-1);
    if (e.key === "ArrowRight") stepLightbox(+1);
  });

  lbImgArea.addEventListener("touchstart", function (e) {
    if (lightbox.classList.contains("hidden")) return;
    lbTouchStartX = (e.touches && e.touches[0] ? e.touches[0].clientX : null);
  }, { passive: true });

  lbImgArea.addEventListener("touchend", function (e) {
    if (lightbox.classList.contains("hidden")) return;
    var endX = (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : null);
    if (lbTouchStartX == null || endX == null) return;
    var dx = endX - lbTouchStartX;
    lbTouchStartX = null;
    if (Math.abs(dx) < 50) return;
    stepLightbox(dx > 0 ? -1 : +1);
  }, { passive: true });

  function normalizeRows(rows, tabName) {
    var list = [];
    for (var i = 0; i < rows.length; i++) {
      var r = rows[i] || {};
      var id = (r.id != null && String(r.id).trim() ? String(r.id).trim() : (tabName + "_" + (i + 1)));
      var order = toNumberSafe(r.order, i + 1);
      var images = parsePhotos(r.photos);

      list.push({
        id: id,
        name: String(r.name || "").trim(),
        color: String(r.color || "").trim(),
        finish: String(r.finish || "").trim(),
        desc: String(r.desc || "").trim(),
        priceNew: String(r.price_new || "").trim(),
        priceOld: String(r.price_old || "").trim(),
        tag: tabName === "interior" ? "Межкомн." : "Входная",
        images: images,
        _order: order
      });
    }

    list.sort(function (a, b) {
      return (a._order || 0) - (b._order || 0);
    });

    return list;
  }

  function setCounts(filteredLen, totalLen, hasQuery) {
    var text = "Позиции: " + totalLen + (hasQuery ? " (найдено: " + filteredLen + ")" : "");
    if (countBadgePublic) countBadgePublic.textContent = text;
  }

  function render() {
    var q = getQuery();
    var list = getActiveList();

    if (isLoading) {
      gridEl.innerHTML = '<div class="badge" style="grid-column:1/-1; padding:12px;">Загрузка каталога…</div>';
      setCounts(0, 0, false);
      return;
    }

    if (loadError) {
      gridEl.innerHTML = '<div class="badge" style="grid-column:1/-1; padding:12px; border-color: rgba(255,90,106,.35);">Не удалось загрузить каталог. Проверьте доступ к таблице и попробуйте обновить страницу.<br><br><b>Техническая ошибка:</b> ' + escapeHtml(loadError) + '</div>';
      setCounts(0, 0, false);
      return;
    }

    var filtered = list;
    if (q) {
      filtered = [];
      for (var i = 0; i < list.length; i++) {
        var x = list[i];
        var hay = (x.name + " " + x.color + " " + x.finish + " " + x.desc + " " + x.priceNew + " " + x.priceOld).toLowerCase();
        if (hay.indexOf(q) !== -1) filtered.push(x);
      }
    }

    setCounts(filtered.length, list.length, !!q);
    gridEl.innerHTML = "";

    for (var idx = 0; idx < filtered.length; idx++) {
      var item = filtered[idx];

      var card = document.createElement("article");
      card.className = "card" + (selectedCardId === item.id ? " selected" : "");

      var imgs = item.images || [];
      var hasImgs = imgs.length > 0;
      var firstSrc = hasImgs ? imgs[0] : "";

      var dots = "";
      if (hasImgs && imgs.length > 1) {
        var ds = [];
        for (var di = 0; di < imgs.length; di++) ds.push('<span class="dot ' + (di === 0 ? "active" : "") + '"></span>');
        dots = '<div class="dots">' + ds.join("") + '</div>';
      }

      var controls = "";
      if (hasImgs && imgs.length > 1) {
        controls = '<div class="gallery-controls">'
          + '<button class="gbtn" data-prev="' + escapeHtml(item.id) + '" type="button">‹</button>'
          + '<button class="gbtn" data-next="' + escapeHtml(item.id) + '" type="button">›</button>'
          + '</div>';
      }

      var inThumbs = "";
      if (selectedCardId === item.id && imgs.length) {
        var ts = [];
        for (var ti = 0; ti < imgs.length; ti++) {
          ts.push('<div class="in-thumb ' + (ti === 0 ? "active" : "") + '" data-jump="' + escapeHtml(item.id) + '" data-index="' + ti + '"><img src="' + escapeHtml(imgs[ti]) + '" alt="' + escapeHtml(item.name || "Фото") + '"></div>');
        }
        inThumbs = '<div class="in-card-thumbs" data-thumbs="' + escapeHtml(item.id) + '">' + ts.join("") + '</div>';
      }

      var subLine = [];
      if (item.color) subLine.push(item.color);
      if (item.finish) subLine.push(item.finish);
      var subHtml = subLine.length ? '<div class="sub">' + escapeHtml(subLine.join(" • ")) + '</div>' : "";

      card.innerHTML = ''
        + '<div class="img" data-gallery="' + escapeHtml(item.id) + '" data-index="0" data-imgwrap="' + escapeHtml(item.id) + '">' 
        + (hasImgs ? '<img class="photo" src="' + escapeHtml(firstSrc) + '" alt="' + escapeHtml(item.name || "Фото") + '">' : "")
        + controls
        + dots
        + '<div class="overlay">'
        + '<span class="pill">' + escapeHtml(item.tag || "") + '</span>'
        + '<span class="pill">#' + (idx + 1) + '</span>'
        + '</div>'
        + '</div>'
        + inThumbs
        + '<div class="content">'
        + '<div class="name">' + escapeHtml(item.name || "Без названия") + '</div>'
        + subHtml
        + '<div class="desc">' + escapeHtml(item.desc || "") + '</div>'
        + '<div class="price">'
        + '<span class="old">' + escapeHtml(item.priceOld || "") + '</span>'
        + '<span class="new">' + escapeHtml(item.priceNew || "") + '</span>'
        + '</div>'
        + '</div>';

      card.addEventListener("click", function (id) {
        return function (e) {
          var t = e.target;
          if (t && (t.closest("button") || t.closest(".thumb"))) return;
          selectedCardId = id;
          render();
        };
      }(item.id));

      gridEl.appendChild(card);
    }

    bindGridHandlers();
  }

  function bindGridHandlers() {
    function updateGallery(id, dir) {
      var el = gridEl.querySelector('[data-gallery="' + CSS.escape(id) + '"]');
      if (!el) return;

      var item = getItemById(id);
      if (!item || !item.images || item.images.length < 2) return;

      var i = parseInt(el.getAttribute("data-index") || "0", 10);
      i = (i + dir + item.images.length) % item.images.length;
      el.setAttribute("data-index", String(i));

      var img = el.querySelector("img.photo");
      if (img) img.src = item.images[i];

      var dots = el.querySelectorAll(".dot");
      for (var d = 0; d < dots.length; d++) dots[d].classList.toggle("active", d === i);

      var thumbsWrap = gridEl.querySelector('[data-thumbs="' + CSS.escape(id) + '"]');
      if (thumbsWrap) {
        var ths = thumbsWrap.querySelectorAll(".in-thumb");
        for (var t = 0; t < ths.length; t++) {
          ths[t].classList.toggle("active", ths[t].getAttribute("data-index") === String(i));
        }
      }
    }

    var prevs = gridEl.querySelectorAll("[data-prev]");
    for (var i = 0; i < prevs.length; i++) {
      prevs[i].addEventListener("click", function (b) {
        return function (e) { e.stopPropagation(); updateGallery(b.getAttribute("data-prev"), -1); };
      }(prevs[i]));
    }

    var nexts = gridEl.querySelectorAll("[data-next]");
    for (var j = 0; j < nexts.length; j++) {
      nexts[j].addEventListener("click", function (b) {
        return function (e) { e.stopPropagation(); updateGallery(b.getAttribute("data-next"), +1); };
      }(nexts[j]));
    }

    // миниатюры: одинарный тап открывает полноэкранный
    var jumps = gridEl.querySelectorAll("[data-jump]");
    for (var k = 0; k < jumps.length; k++) {
      jumps[k].addEventListener("click", function (th) {
        return function (e) {
          e.stopPropagation();
          var id = th.getAttribute("data-jump");
          var idx = parseInt(th.getAttribute("data-index") || "0", 10);
          openLightbox(id, idx);
        };
      }(jumps[k]));
    }

    // большое фото: одинарный клик -> полноэкранный
    var wraps = gridEl.querySelectorAll("[data-imgwrap]");
    for (var w = 0; w < wraps.length; w++) {
      wraps[w].addEventListener("click", function (wrap) {
        return function (e) {
          var t = e.target;
          if (t && t.closest && t.closest("button")) return;
          e.stopPropagation();
          var id = wrap.getAttribute("data-imgwrap");
          var idx = parseInt(wrap.getAttribute("data-index") || "0", 10);
          openLightbox(id, idx);
        };
      }(wraps[w]));
    }
  }

  function loadAll() {
    isLoading = true;
    loadError = "";
    render();

    var p1 = httpGetJson(sheetUrl(SHEET_INTERIOR));
    var p2 = httpGetJson(sheetUrl(SHEET_ENTRANCE));

    Promise.all([p1, p2]).then(function (res) {
      dataInterior = normalizeRows(res[0] || [], "interior");
      dataEntrance = normalizeRows(res[1] || [], "entrance");
      isLoading = false;
      render();
    }).catch(function (e) {
      isLoading = false;
      loadError = (e && e.message) ? e.message : String(e);
      render();
    });
  }

  // tabs
  for (var i = 0; i < tabsEl.length; i++) {
    tabsEl[i].addEventListener("click", function (btn) {
      return function () {
        activeTab = btn.dataset.tab;
        selectedCardId = null;
        for (var j = 0; j < tabsEl.length; j++) {
          var isActive = tabsEl[j].dataset.tab === activeTab;
          tabsEl[j].classList.toggle("active", isActive);
          tabsEl[j].setAttribute("aria-selected", isActive ? "true" : "false");
        }
        render();
      };
    }(tabsEl[i]));
  }

  // поиск
  if (searchPublicEl) {
    searchPublicEl.addEventListener("input", function () { render(); });
  }

  // снять выделение кликом по пустому месту
  document.addEventListener("click", function (ev) {
    if (lightbox && !lightbox.classList.contains("hidden")) return;
    var within = ev.target && ev.target.closest ? ev.target.closest(".card") : null;
    if (!within && selectedCardId !== null) {
      selectedCardId = null;
      render();
    }
  });

  // ===== Самотесты (в консоли), чтобы ловить ошибки сразу =====
  function assert(cond, msg) { if (!cond) throw new Error("TEST FAILED: " + msg); }
  function runSelfTests() {
    var a = parsePhotos("a.jpg,b.jpg\nc.jpg");
    assert(a.length === 3, "parsePhotos: split по запятой и переносу строки");
    var b = parsePhotos("  x.jpg  ,   ");
    assert(b.length === 1 && b[0] === "x.jpg", "parsePhotos: trim и игнор пустых");
    var c = CSS.escape('a"b');
    assert(typeof c === "string" && c !== 'a"b', "CSS.escape: экранирует спецсимволы");
    // eslint-disable-next-line no-console
    console.log("Self-tests: OK");
  }

  // init
  for (var jj = 0; jj < tabsEl.length; jj++) {
    var isActive = tabsEl[jj].dataset.tab === activeTab;
    tabsEl[jj].classList.toggle("active", isActive);
    tabsEl[jj].setAttribute("aria-selected", isActive ? "true" : "false");
  }

  runSelfTests();
  loadAll();
  </script>
</body>
</html>

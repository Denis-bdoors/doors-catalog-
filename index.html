<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ –¥–≤–µ—Ä–µ–π</title>
  <style>
    :root{
      --bg:#0b1220; --muted:#9db0d0; --text:#eef3ff;
      --accent:#6aa3ff; --danger:#ff5a6a; --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(106,163,255,.35), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(51,212,157,.25), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    header{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin-bottom:14px;}
    .title h1{margin:0; font-size:20px; letter-spacing:.2px; user-select:none;}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center; background: rgba(255,255,255,.03); border:1px solid var(--border); padding:8px; border-radius:999px;}
    .tab{border:0; cursor:pointer; padding:10px 14px; border-radius:999px; background:transparent; color:var(--muted); font-weight:700;}
    .tab.active{background: rgba(106,163,255,.18); color:var(--text); box-shadow: inset 0 0 0 1px rgba(106,163,255,.35);}

    .panel{background: rgba(255,255,255,.03); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow: var(--shadow); width:100%;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    .field{display:flex; flex-direction:column; gap:6px; min-width:160px;}
    label{font-size:12px; color:var(--muted)}
    input{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background: rgba(0,0,0,.18); color: var(--text); outline:none;}

    .btn{border:0; cursor:pointer; padding:10px 12px; border-radius:12px; background: rgba(106,163,255,.18); color: var(--text); font-weight:800; box-shadow: inset 0 0 0 1px rgba(106,163,255,.35); white-space:nowrap;}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background: rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,.10); color: var(--text); font-weight:750;}
    .btn.danger{background: rgba(255,90,106,.16); box-shadow: inset 0 0 0 1px rgba(255,90,106,.35);}

    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:14px 0 10px;}
    .badge{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.03); color:var(--muted); font-size:12px;}
    .search{display:flex; gap:10px; align-items:center; flex:1; justify-content:flex-end; min-width:260px;}

    .grid{display:grid; gap:var(--gap); grid-template-columns: repeat(4, minmax(0, 1fr)); margin-top:12px;}
    .card{background: rgba(255,255,255,.03); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow: var(--shadow); display:flex; flex-direction:column; min-height:220px; cursor:pointer;}
    .card.selected{border-color: rgba(106,163,255,.55); box-shadow: 0 0 0 2px rgba(106,163,255,.22), var(--shadow);}

    .hidden{display:none!important}

    .img{position:relative; aspect-ratio:4/3; background:
        linear-gradient(135deg, rgba(106,163,255,.35), rgba(51,212,157,.20)),
        radial-gradient(500px 250px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        rgba(0,0,0,.15);
      padding:10px; border-bottom:1px solid var(--border); overflow:hidden;}
    .img img.photo{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; z-index:1;}
    .pill{font-size:11px; padding:6px 8px; border-radius:999px; background: rgba(0,0,0,.30); border:1px solid rgba(255,255,255,.12); color:var(--text);}
    .img .overlay{position:relative; z-index:2; width:100%; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; height:100%;}

    .img .gallery-controls{position:absolute; left:10px; right:10px; top:10px; z-index:3; display:flex; justify-content:space-between; pointer-events:none;}
    .img .gbtn{pointer-events:auto; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.30); color: var(--text); border-radius:999px; padding:6px 10px; font-weight:900; cursor:pointer;}
    .img .dots{position:absolute; left:0; right:0; bottom:8px; z-index:3; display:flex; gap:6px; justify-content:center; pointer-events:none;}
    .img .dot{width:7px; height:7px; border-radius:999px; background: rgba(255,255,255,.35); border:1px solid rgba(0,0,0,.25);}
    .img .dot.active{background: rgba(255,255,255,.85);}

    /* –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .in-card-thumbs{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border); overflow:auto; background: rgba(0,0,0,.10)}
    .in-card-thumbs::-webkit-scrollbar{height:8px}
    .in-card-thumbs::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10); border-radius:999px}
    .in-thumb{flex:0 0 auto; width:56px; height:56px; border-radius:12px; border:1px solid rgba(255,255,255,.10); overflow:hidden; background: rgba(0,0,0,.2)}
    .in-thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .in-thumb.active{border-color: rgba(106,163,255,.7); box-shadow: 0 0 0 2px rgba(106,163,255,.20)}

    .content{padding:12px; display:flex; flex-direction:column; gap:8px; flex:1}
    .name{font-weight:900; line-height:1.25}
    .sub{color:var(--muted); font-size:12.5px; line-height:1.35}
    .desc{color:var(--muted); font-size:12.5px; line-height:1.35; flex:1}

    .price{font-weight:900; display:flex; flex-wrap:wrap; gap:8px; align-items:baseline}
    .price .old{color:var(--muted); text-decoration:line-through; font-weight:800; font-size:12.5px}
    .price .new{font-weight:950}
    .price .new:empty{display:none}
    .price .old:empty{display:none}

    .actions{display:flex; gap:8px; margin-top:6px; flex-wrap:wrap}
    .actions .btn{padding:9px 10px; border-radius:12px; font-size:13px}

    /* –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ –≤ –∞–¥–º–∏–Ω–∫–µ */
    .thumbs{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .thumb{width:52px; height:52px; border-radius:12px; border:1px solid var(--border); overflow:hidden; background: rgba(0,0,0,.15); position:relative}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .thumb .x{position:absolute; top:5px; right:5px; border:1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.45); color:var(--text); border-radius:999px; padding:2px 7px; cursor:pointer; font-weight:950; line-height:1}
    .thumb .cover{position:absolute; left:5px; top:5px; border:1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.45); color:var(--text); border-radius:999px; padding:2px 7px; cursor:pointer; font-weight:950; line-height:1}
    .thumb .flag{position:absolute; left:6px; bottom:6px; font-size:10px; padding:3px 6px; border-radius:999px; background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.14)}

    dialog{border:1px solid var(--border); border-radius:18px; background:#0c1526; color: var(--text); box-shadow: var(--shadow); width:min(860px, 92vw);}
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .dialog-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--border)}
    .dialog-title{font-weight:950}
    .dialog-body{padding:14px}
    .dialog-actions{display:flex; gap:10px; justify-content:flex-end; padding:12px 14px; border-top:1px solid var(--border)}

    /* Lightbox */
    .lightbox{position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,.78); display:flex; align-items:center; justify-content:center; padding:14px;}
    .lightbox.hidden{display:none}
    .lb-inner{width:min(1100px, 96vw); height:min(84vh, 760px); position:relative; border-radius:22px; overflow:hidden; border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(600px 300px at 20% 0%, rgba(106,163,255,.18), transparent 60%), rgba(10,16,30,.85);
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .lb-img{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:18px;}
    .lb-img img{max-width:100%; max-height:100%; border-radius:18px; box-shadow: 0 18px 50px rgba(0,0,0,.45);}
    .lb-top{position:absolute; left:12px; right:12px; top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; z-index:2;}
    .lb-chip{padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.35); color: var(--text); font-weight:850; font-size:12px;}
    .lb-btn{border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.35); color: var(--text); border-radius:999px; padding:10px 12px; cursor:pointer; font-weight:950;}
    .lb-nav{position:absolute; left:12px; right:12px; top:50%; transform:translateY(-50%); display:flex; justify-content:space-between; z-index:2; pointer-events:none;}
    .lb-nav .lb-btn{pointer-events:auto; padding:12px 14px;}
    .lb-thumbs{position:absolute; left:0; right:0; bottom:0; padding:10px; display:flex; gap:8px; overflow:auto; background: linear-gradient(to top, rgba(0,0,0,.55), transparent);
      z-index:2;
    }
    .lb-thumbs::-webkit-scrollbar{height:8px}
    .lb-thumbs::-webkit-scrollbar-thumb{background: rgba(255,255,255,.12); border-radius:999px}
    .lb-t{flex:0 0 auto; width:56px; height:56px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); cursor:pointer}
    .lb-t img{width:100%; height:100%; object-fit:cover; display:block}
    .lb-t.active{border-color: rgba(106,163,255,.75); box-shadow: 0 0 0 2px rgba(106,163,255,.18)}

    @media (max-width:1000px){.grid{grid-template-columns: repeat(3, minmax(0, 1fr));}}
    @media (max-width:720px){.grid{grid-template-columns: repeat(2, minmax(0, 1fr));} header{gap:10px} .tabs{width:100%; justify-content:center} .title{width:100%} .lb-inner{height:82vh}}
    @media (max-width:420px){.grid{grid-template-columns: 1fr;} .lb-inner{height:86vh}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1 id="siteTitle">–ö–∞—Ç–∞–ª–æ–≥ –¥–≤–µ—Ä–µ–π</h1>
      </div>

      <div class="tabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞">
        <button class="tab active" data-tab="interior" role="tab" aria-selected="true">–ú–µ–∂–∫–æ–º–Ω–∞—Ç–Ω—ã–µ</button>
        <button class="tab" data-tab="entrance" role="tab" aria-selected="false">–í—Ö–æ–¥–Ω—ã–µ</button>
        <button class="btn secondary hidden" id="adminBtn" type="button" style="padding:10px 14px; border-radius:999px;">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>
        <span class="badge hidden" id="adminBadge">–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</span>
      </div>
    </header>

    <div class="panel" id="adminPanel">
      <div class="row">
        <div class="field">
          <label for="modelName">–ú–æ–¥–µ–ª—å (–Ω–∞–∑–≤–∞–Ω–∏–µ)</label>
          <input id="modelName" placeholder="–ù–∞–ø—Ä. –õ–∏—Ä–∞ 3D" />
        </div>
        <div class="field">
          <label for="modelColor">–¶–≤–µ—Ç</label>
          <input id="modelColor" placeholder="–ù–∞–ø—Ä. –ë–µ–ª—ã–π –¥—É–±" />
        </div>
        <div class="field">
          <label for="modelFinish">–ü–æ–∫—Ä—ã—Ç–∏–µ</label>
          <input id="modelFinish" placeholder="–ù–∞–ø—Ä. –≠–∫–æ—à–ø–æ–Ω / –ü–í–• / –≠–º–∞–ª—å" />
        </div>
        <div class="field">
          <label for="modelPriceNew">–¶–µ–Ω–∞ (—Å–æ —Å–∫–∏–¥–∫–æ–π)</label>
          <input id="modelPriceNew" placeholder="–ù–∞–ø—Ä. 199 ‚Ç¨ –∏–ª–∏ 24 900 ‚ÇΩ" />
        </div>
        <div class="field">
          <label for="modelPriceOld">–¶–µ–Ω–∞ (–±–µ–∑ —Å–∫–∏–¥–∫–∏, –∑–∞—á—ë—Ä–∫–Ω—É—Ç–∞—è)</label>
          <input id="modelPriceOld" placeholder="–ù–∞–ø—Ä. 249 ‚Ç¨" />
        </div>
        <div class="field" style="flex:1.2">
          <label for="modelDesc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input id="modelDesc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: –º–∞—Ç–µ—Ä–∏–∞–ª, –∑–∞–º–æ–∫, —Ä–∞–∑–º–µ—Ä..." />
        </div>
        <div class="field" style="flex:1.1">
          <label for="modelImagesFiles">–§–æ—Ç–æ (–¥–æ 5 —à—Ç.)</label>
          <input id="modelImagesFiles" type="file" accept="image/*" multiple />
          <div class="thumbs" id="addThumbs"></div>
          <div class="badge" style="margin-top:8px;">üí° –û–±–ª–æ–∂–∫–∞ ‚Äî —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ. –ù–∞–∂–º–∏—Ç–µ ¬´‚òÖ¬ª –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä–µ.</div>
        </div>
        <div class="field" style="flex:.7">
          <label>&nbsp;</label>
          <button class="btn" id="addBtn" type="button">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="meta">
        <div class="badge" id="countBadge">–ü–æ–∑–∏—Ü–∏–∏: 0</div>
        <div class="search">
          <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª–∏/—Ü–≤–µ—Ç—É/–ø–æ–∫—Ä—ã—Ç–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é/—Ü–µ–Ω–µ..." />
          <button class="btn secondary" id="resetBtn" type="button" title="–í–µ—Ä–Ω—É—Ç—å –¥–µ–º–æ-50 –ø–æ–∑–∏—Ü–∏–π">–°–±—Ä–æ—Å (–¥–µ–º–æ)</button>
          <button class="btn danger" id="clearBtn" type="button" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ">–û—á–∏—Å—Ç–∏—Ç—å –≤–∫–ª–∞–¥–∫—É</button>
        </div>
      </div>

      <div class="badge" style="margin-top:8px;">
        ‚ö†Ô∏è –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (—Å–∂–∞—Ç—ã–µ JPEG). –û—á–µ–Ω—å –º–Ω–æ–≥–æ —Ñ–æ—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç ¬´—É—Ç—è–∂–µ–ª–∏—Ç—å¬ª –∫–∞—Ç–∞–ª–æ–≥.
      </div>
    </div>

    <div class="panel hidden" id="publicSearchPanel" style="margin-top:12px;">
      <div class="meta" style="margin:0;">
        <div class="badge" id="countBadgePublic">–ü–æ–∑–∏—Ü–∏–∏: 0</div>
        <div class="search">
          <input id="searchPublic" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª–∏/—Ü–≤–µ—Ç—É/–ø–æ–∫—Ä—ã—Ç–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é/—Ü–µ–Ω–µ..." />
        </div>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <dialog id="editDialog">
    <div class="dialog-head">
      <div class="dialog-title" id="editTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn secondary" id="editClose" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div class="dialog-body">
      <div class="row">
        <div class="field">
          <label for="editName">–ú–æ–¥–µ–ª—å (–Ω–∞–∑–≤–∞–Ω–∏–µ)</label>
          <input id="editName" />
        </div>
        <div class="field">
          <label for="editColor">–¶–≤–µ—Ç</label>
          <input id="editColor" />
        </div>
        <div class="field">
          <label for="editFinish">–ü–æ–∫—Ä—ã—Ç–∏–µ</label>
          <input id="editFinish" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="field">
          <label for="editDesc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <input id="editDesc" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="field">
          <label for="editPriceNew">–¶–µ–Ω–∞ (—Å–æ —Å–∫–∏–¥–∫–æ–π)</label>
          <input id="editPriceNew" />
        </div>
        <div class="field">
          <label for="editPriceOld">–¶–µ–Ω–∞ (–±–µ–∑ —Å–∫–∏–¥–∫–∏)</label>
          <input id="editPriceOld" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="field">
        <label for="editImagesFiles">–§–æ—Ç–æ (–¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë, –¥–æ 5)</label>
        <input id="editImagesFiles" type="file" accept="image/*" multiple />
      </div>

      <div style="height:10px"></div>

      <div class="field">
        <label>–¢–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ (‚òÖ = –æ–±–ª–æ–∂–∫–∞, √ó = —É–¥–∞–ª–∏—Ç—å)</label>
        <div class="thumbs" id="editThumbs"></div>
      </div>
    </div>
    <div class="dialog-actions">
      <button class="btn secondary" id="editCancel" type="button">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="editSave" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </dialog>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox hidden" aria-hidden="true">
    <div class="lb-inner" role="dialog" aria-modal="true" aria-label="–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
      <div class="lb-top">
        <div class="lb-chip" id="lbTitle">–§–æ—Ç–æ</div>
        <button class="lb-btn" id="lbClose" type="button">‚úï</button>
      </div>
      <div class="lb-nav">
        <button class="lb-btn" id="lbPrev" type="button">‚Äπ</button>
        <button class="lb-btn" id="lbNext" type="button">‚Ä∫</button>
      </div>
      <div class="lb-img" id="lbImgArea">
        <img id="lbImg" alt="–§–æ—Ç–æ" />
      </div>
      <div class="lb-thumbs" id="lbThumbs"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "doors_catalog_v8";
    const ADMIN_PASSWORD = "admin123"; // –ø–æ–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å
    const MAX_PHOTOS = 5;

    const IMG_MAX_SIDE = 1280;
    const IMG_QUALITY  = 0.78;

    const tabsEl = document.querySelectorAll(".tab");
    const gridEl = document.getElementById("grid");

    const adminBtn = document.getElementById("adminBtn");
    const adminBadge = document.getElementById("adminBadge");
    const adminPanel = document.getElementById("adminPanel");
    const publicSearchPanel = document.getElementById("publicSearchPanel");

    const siteTitle = document.getElementById("siteTitle");

    const countBadge = document.getElementById("countBadge");
    const countBadgePublic = document.getElementById("countBadgePublic");

    const nameEl = document.getElementById("modelName");
    const colorEl = document.getElementById("modelColor");
    const finishEl = document.getElementById("modelFinish");
    const priceNewEl = document.getElementById("modelPriceNew");
    const priceOldEl = document.getElementById("modelPriceOld");
    const descEl  = document.getElementById("modelDesc");

    const addFilesEl = document.getElementById("modelImagesFiles");
    const addThumbsEl = document.getElementById("addThumbs");

    const addBtn  = document.getElementById("addBtn");
    const searchEl = document.getElementById("search");
    const searchPublicEl = document.getElementById("searchPublic");
    const resetBtn = document.getElementById("resetBtn");
    const clearBtn = document.getElementById("clearBtn");

    const editDialog = document.getElementById("editDialog");
    const editTitle = document.getElementById("editTitle");
    const editClose = document.getElementById("editClose");
    const editCancel = document.getElementById("editCancel");
    const editSave = document.getElementById("editSave");

    const editName = document.getElementById("editName");
    const editColor = document.getElementById("editColor");
    const editFinish = document.getElementById("editFinish");
    const editDesc = document.getElementById("editDesc");

    const editPriceNew = document.getElementById("editPriceNew");
    const editPriceOld = document.getElementById("editPriceOld");
    const editFilesEl = document.getElementById("editImagesFiles");
    const editThumbsEl = document.getElementById("editThumbs");

    // lightbox
    const lightbox = document.getElementById("lightbox");
    const lbClose = document.getElementById("lbClose");
    const lbPrev = document.getElementById("lbPrev");
    const lbNext = document.getElementById("lbNext");
    const lbImg = document.getElementById("lbImg");
    const lbTitle = document.getElementById("lbTitle");
    const lbThumbs = document.getElementById("lbThumbs");
    const lbImgArea = document.getElementById("lbImgArea");

    // –ê–¥–º–∏–Ω-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let isAdmin = sessionStorage.getItem("doors_admin") === "1";
    // –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é: –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 7 —Ç–∞–ø–æ–≤ –∏ –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞.
    let adminBtnVisible = false;

    let state = loadState();
    let activeTab = state.activeTab || "interior";

    let selectedCardId = null;
    let pendingAddImages = [];

    let editingId = null;
    let editImages = [];

    // lightbox state
    let lbCardId = null;
    let lbIndex = 0;
    let lbTouchStartX = null;

    // dnd state
    let dragFromId = null;

    function uid(){
      // crypto.randomUUID –Ω–µ –≤–µ–∑–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
      if(typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function makeDemoItems(type, n=50){
      const isInterior = type === "interior";
      const baseNames = isInterior
        ? ["–õ–∏—Ä–∞", "–°–æ–ª–æ", "–†–æ–Ω–¥–æ", "–ö–ª–∞—Å—Å–∏–∫", "–ù–µ–æ", "–°–∫–∞–Ω–¥–∏", "–õ–æ—Ñ—Ç", "–ú–æ–¥–µ—Ä–Ω", "–≠–∫–æ", "–ü—Ä–µ–º—å–µ—Ä"]
        : ["–ì—Ä–∞–Ω–∏—Ç", "–§–æ—Ä–ø–æ—Å—Ç", "–ë–∞—Ä—å–µ—Ä", "–°—Ç—Ä–∞–∂", "–¢–∏—Ç–∞–Ω", "–ê–ª—å—Ñ–∞", "–í–µ–∫—Ç–æ—Ä", "–†—É–±–µ–∂", "–ë—Ä–æ–Ω—è", "–°–µ–π—Ñ"];
      const colors = isInterior
        ? ["–ë–µ–ª—ã–π", "–ë–µ–ª—ã–π –¥—É–±", "–î—É–± –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π", "–í–µ–Ω–≥–µ", "–°–µ—Ä—ã–π", "–û—Ä–µ—Ö", "–ö–∞—à–µ–º–∏—Ä", "–ì—Ä–∞—Ñ–∏—Ç"]
        : ["–ê–Ω—Ç–∏–∫ –º–µ–¥—å", "–ê–Ω—Ç—Ä–∞—Ü–∏—Ç", "–ß—ë—Ä–Ω—ã–π", "–°–µ—Ä–µ–±—Ä–æ", "–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π", "–¢—ë–º–Ω—ã–π –¥—É–±"];
      const finishes = isInterior
        ? ["–≠–∫–æ—à–ø–æ–Ω", "–ü–í–•", "–≠–º–∞–ª—å", "–®–ø–æ–Ω", "–õ–∞–º–∏–Ω–∞—Ç"]
        : ["–ü–æ—Ä–æ—à–∫–æ–≤–æ–µ", "–ú–î–§-–ø–∞–Ω–µ–ª—å", "–ê–Ω—Ç–∏–≤–∞–Ω–¥–∞–ª", "–ü–í–•"];
      const descA = isInterior
        ? ["–ú–î–§", "–°–∫—Ä—ã—Ç—ã–µ –ø–µ—Ç–ª–∏", "–ú–∞–≥–Ω–∏—Ç–Ω—ã–π –∑–∞–º–æ–∫", "–®—É–º–æ–∏–∑–æ–ª—è—Ü–∏—è", "–°—Ç–µ–∫–ª–æ —Å–∞—Ç–∏–Ω"]
        : ["–°—Ç–∞–ª—å 1.5 –º–º", "2 –∫–æ–Ω—Ç—É—Ä–∞ —É–ø–ª–æ—Ç–Ω–µ–Ω–∏—è", "–¢—ë–ø–ª—ã–π —Ä–∞–∑—Ä—ã–≤", "–ó–∞–º–∫–∏ 2 –∫–ª–∞—Å—Å–∞", "–ù–æ—á–Ω–∞—è –∑–∞–¥–≤–∏–∂–∫–∞"];

      const items = [];
      for(let i=1;i<=n;i++){
        const name = baseNames[i % baseNames.length] + " " + (100 + i);
        const color = colors[i % colors.length];
        const finish = finishes[i % finishes.length];
        const desc = descA[i % descA.length];

        const newP = isInterior ? (80 + (i%20)*5) : (180 + (i%25)*7);
        const oldP = isInterior ? (newP + 30) : (newP + 50);

        items.push({
          id: uid(),
          name,
          color,
          finish,
          priceNew: newP + " ‚Ç¨",
          priceOld: oldP + " ‚Ç¨",
          desc,
          tag: isInterior ? "–ú–µ–∂–∫–æ–º–Ω." : "–í—Ö–æ–¥–Ω–∞—è",
          images: []
        });
      }
      return items;
    }

    function defaultState(){
      return {
        activeTab: "interior",
        interior: makeDemoItems("interior", 50),
        entrance: makeDemoItems("entrance", 50)
      };
    }

    function migrateItem(x){
      const name = x?.name ?? "";
      return {
        id: x?.id ?? uid(),
        name,
        color: x?.color ?? "",
        finish: x?.finish ?? "",
        priceNew: x?.priceNew ?? "",
        priceOld: x?.priceOld ?? "",
        desc: x?.desc ?? "",
        tag: x?.tag ?? "",
        images: (x?.images || []).slice(0, MAX_PHOTOS)
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        if(!parsed.interior || !parsed.entrance) return defaultState();
        parsed.interior = (parsed.interior || []).map(migrateItem);
        parsed.entrance = (parsed.entrance || []).map(migrateItem);
        return parsed;
      }catch(_){
        return defaultState();
      }
    }

    function saveState(){
      state.activeTab = activeTab;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function getActiveList(){
      return activeTab === "interior" ? state.interior : state.entrance;
    }

    function setActiveList(list){
      if(activeTab === "interior") state.interior = list;
      else state.entrance = list;
    }

    function setAdminUI(){
      const showBtn = isAdmin || adminBtnVisible;
      adminBtn.classList.toggle("hidden", !showBtn);

      adminPanel.classList.toggle("hidden", !isAdmin);
      adminBadge.classList.toggle("hidden", !isAdmin);
      adminBtn.textContent = isAdmin ? "–í—ã–π—Ç–∏" : "–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω";
      publicSearchPanel.classList.toggle("hidden", isAdmin);

      if(isAdmin) searchEl.value = searchPublicEl.value || "";
      else searchPublicEl.value = searchEl.value || "";
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getQuery(){
      return (isAdmin ? (searchEl.value||"") : (searchPublicEl.value||""))
        .trim()
        .toLowerCase();
    }

    function makeCover(images, idx){
      if(!Array.isArray(images) || images.length === 0) return images;
      if(idx <= 0 || idx >= images.length) return images;
      const copy = [...images];
      const [picked] = copy.splice(idx, 1);
      copy.unshift(picked);
      return copy;
    }

    async function fileToCompressedDataURL(file){
      let bitmap;
      try{
        bitmap = await createImageBitmap(file);
      }catch(_){
        const dataUrl = await new Promise((resolve, reject)=>{
          const r = new FileReader();
          r.onload = ()=> resolve(String(r.result || ""));
          r.onerror = ()=> reject(new Error("FileReader error"));
          r.readAsDataURL(file);
        });
        bitmap = await new Promise((resolve, reject)=>{
          const img = new Image();
          img.onload = ()=> resolve(img);
          img.onerror = ()=> reject(new Error("Image load error"));
          img.src = dataUrl;
        });
      }

      const w = bitmap.width;
      const h = bitmap.height;
      const scale = Math.min(1, IMG_MAX_SIDE / Math.max(w, h));
      const outW = Math.max(1, Math.round(w * scale));
      const outH = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement("canvas");
      canvas.width = outW;
      canvas.height = outH;
      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(bitmap, 0, 0, outW, outH);

      const data = canvas.toDataURL("image/jpeg", IMG_QUALITY);
      try{ if(bitmap && bitmap.close) bitmap.close(); }catch(_){ }
      return data;
    }

    async function readFilesCompressedWithLimit(fileList, remainingSlots){
      const files = Array.from(fileList || []);
      const take = files.slice(0, Math.max(0, remainingSlots));
      const out = [];
      for(const f of take){ out.push(await fileToCompressedDataURL(f)); }
      return { out, skipped: Math.max(0, files.length - take.length) };
    }

    function renderThumbs(container, images, handlers){
      const { onRemove, onMakeCover } = handlers || {};
      container.innerHTML = "";
      (images || []).forEach((src, idx)=>{
        const t = document.createElement("div");
        t.className = "thumb";
        t.innerHTML = `<img src="${escapeHtml(src)}" alt="–§–æ—Ç–æ ${idx+1}">`;

        if(idx === 0 && (images || []).length){
          const flag = document.createElement("div");
          flag.className = "flag";
          flag.textContent = "–û–±–ª–æ–∂–∫–∞";
          t.appendChild(flag);
        }

        if(onMakeCover){
          const c = document.createElement("button");
          c.type = "button";
          c.className = "cover";
          c.textContent = "‚òÖ";
          c.title = "–°–¥–µ–ª–∞—Ç—å –æ–±–ª–æ–∂–∫–æ–π";
          c.addEventListener("click", (e)=>{ e.stopPropagation(); onMakeCover(idx); });
          t.appendChild(c);
        }

        if(onRemove){
          const b = document.createElement("button");
          b.type = "button";
          b.className = "x";
          b.textContent = "√ó";
          b.title = "–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ";
          b.addEventListener("click", (e)=>{ e.stopPropagation(); onRemove(idx); });
          t.appendChild(b);
        }

        container.appendChild(t);
      });
    }

    // ---------- Lightbox ----------
    function getItemById(id){
      return getActiveList().find(x => x.id === id);
    }

    function openLightbox(cardId, index){
      const item = getItemById(cardId);
      if(!item || !Array.isArray(item.images) || item.images.length === 0) return;

      lbCardId = cardId;
      lbIndex = Math.max(0, Math.min(index || 0, item.images.length-1));
      selectedCardId = cardId;

      lightbox.classList.remove("hidden");
      lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      render();
      renderLightbox();
    }

    function closeLightbox(){
      lightbox.classList.add("hidden");
      lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      lbCardId = null;
      lbIndex = 0;
    }

    function renderLightbox(){
      const item = lbCardId ? getItemById(lbCardId) : null;
      const imgs = item && Array.isArray(item.images) ? item.images : [];
      if(!imgs.length){
        closeLightbox();
        return;
      }

      lbIndex = (lbIndex + imgs.length) % imgs.length;
      lbImg.src = imgs[lbIndex];
      lbImg.alt = item?.name ? (item.name + ` ‚Äî —Ñ–æ—Ç–æ ${lbIndex+1}`) : `–§–æ—Ç–æ ${lbIndex+1}`;
      const meta = [item?.name, item?.color, item?.finish].filter(Boolean).join(" ‚Ä¢ ");
      lbTitle.textContent = `${meta || "–§–æ—Ç–æ"} ‚Ä¢ ${lbIndex+1}/${imgs.length}`;

      lbThumbs.innerHTML = "";
      imgs.forEach((src, i)=>{
        const t = document.createElement("div");
        t.className = "lb-t" + (i===lbIndex ? " active" : "");
        t.innerHTML = `<img src="${escapeHtml(src)}" alt="">`;
        t.addEventListener("click", (e)=>{ e.stopPropagation(); lbIndex = i; renderLightbox(); });
        lbThumbs.appendChild(t);
      });

      lbPrev.style.visibility = imgs.length > 1 ? "visible" : "hidden";
      lbNext.style.visibility = imgs.length > 1 ? "visible" : "hidden";
    }

    function stepLightbox(dir){
      const item = lbCardId ? getItemById(lbCardId) : null;
      const imgs = item && Array.isArray(item.images) ? item.images : [];
      if(imgs.length < 2) return;
      lbIndex = (lbIndex + dir + imgs.length) % imgs.length;
      renderLightbox();
    }

    lbClose.addEventListener("click", (e)=>{ e.stopPropagation(); closeLightbox(); });
    lbPrev.addEventListener("click", (e)=>{ e.stopPropagation(); stepLightbox(-1); });
    lbNext.addEventListener("click", (e)=>{ e.stopPropagation(); stepLightbox(+1); });

    lightbox.addEventListener("click", ()=> closeLightbox());
    document.querySelector(".lb-inner").addEventListener("click", (e)=> e.stopPropagation());

    document.addEventListener("keydown", (e)=>{
      if(lightbox.classList.contains("hidden")) return;
      if(e.key === "Escape") closeLightbox();
      if(e.key === "ArrowLeft") stepLightbox(-1);
      if(e.key === "ArrowRight") stepLightbox(+1);
    });

    lbImgArea.addEventListener("touchstart", (e)=>{
      if(lightbox.classList.contains("hidden")) return;
      lbTouchStartX = e.touches?.[0]?.clientX ?? null;
    }, { passive:true });

    lbImgArea.addEventListener("touchend", (e)=>{
      if(lightbox.classList.contains("hidden")) return;
      const endX = e.changedTouches?.[0]?.clientX ?? null;
      if(lbTouchStartX == null || endX == null) return;
      const dx = endX - lbTouchStartX;
      lbTouchStartX = null;
      if(Math.abs(dx) < 50) return;
      stepLightbox(dx > 0 ? -1 : +1);
    }, { passive:true });

    // ---------- Edit thumbs helpers ----------
    function refreshEditThumbs(){
      if(!editDialog.open) return;
      renderThumbs(editThumbsEl, editImages, {
        onRemove: (i)=>{ editImages.splice(i,1); refreshEditThumbs(); },
        onMakeCover: (i)=>{ editImages = makeCover(editImages, i); refreshEditThumbs(); }
      });
    }

    // ---------- Render main ----------
    function render(){
      setAdminUI();

      if(isAdmin){
        renderThumbs(addThumbsEl, pendingAddImages, {
          onRemove: (i)=>{ pendingAddImages.splice(i,1); render(); },
          onMakeCover: (i)=>{ pendingAddImages = makeCover(pendingAddImages, i); render(); }
        });
      }else{
        addThumbsEl.innerHTML = "";
        pendingAddImages = [];
      }

      tabsEl.forEach(btn=>{
        const isActive = btn.dataset.tab === activeTab;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
      });

      const q = getQuery();
      const list = getActiveList();
      const filtered = q
        ? list.filter(x =>
            (x.name || "").toLowerCase().includes(q) ||
            (x.color || "").toLowerCase().includes(q) ||
            (x.finish || "").toLowerCase().includes(q) ||
            (x.desc || "").toLowerCase().includes(q) ||
            ((x.priceNew || "") + " " + (x.priceOld || "")).toLowerCase().includes(q)
          )
        : list;

      const textCount = `–ü–æ–∑–∏—Ü–∏–∏: ${list.length}${q ? " (–Ω–∞–π–¥–µ–Ω–æ: " + filtered.length + ")" : ""}`;
      countBadge.textContent = textCount;
      countBadgePublic.textContent = textCount;

      gridEl.innerHTML = "";

      for(let idx=0; idx<filtered.length; idx++){
        const item = filtered[idx];
        const card = document.createElement("article");
        card.className = "card" + (selectedCardId === item.id ? " selected" : "");

        if(isAdmin){
          card.setAttribute("draggable", "true");
          card.dataset.dragId = item.id;
        }

        const imgs = Array.isArray(item.images) ? item.images : [];
        const hasImgs = imgs.length > 0;
        const firstSrc = hasImgs ? imgs[0] : "";

        const dots = hasImgs && imgs.length > 1
          ? `<div class="dots">${imgs.map((_,i)=>`<span class="dot ${i===0?"active":""}"></span>`).join("")}</div>`
          : "";

        const controls = hasImgs && imgs.length > 1
          ? `<div class="gallery-controls">
              <button class="gbtn" data-prev="${escapeHtml(item.id)}" type="button">‚Äπ</button>
              <button class="gbtn" data-next="${escapeHtml(item.id)}" type="button">‚Ä∫</button>
            </div>`
          : "";

        const inThumbs = (selectedCardId === item.id && imgs.length)
          ? `<div class="in-card-thumbs" data-thumbs="${escapeHtml(item.id)}">
              ${imgs.map((src,i)=>`<div class="in-thumb ${i===0?"active":""}" data-jump="${escapeHtml(item.id)}" data-index="${i}"><img src="${escapeHtml(src)}" alt="${escapeHtml(item.name||"–§–æ—Ç–æ")}"></div>`).join("")}
            </div>`
          : "";

        const subLine = [item.color, item.finish].filter(Boolean).join(" ‚Ä¢ ");

        card.innerHTML = `
          <div class="img" data-gallery="${escapeHtml(item.id)}" data-index="0" data-imgwrap="${escapeHtml(item.id)}">
            ${hasImgs ? `<img class="photo" src="${escapeHtml(firstSrc)}" alt="${escapeHtml(item.name || "–§–æ—Ç–æ")}">` : ""}
            ${controls}
            ${dots}
            <div class="overlay">
              <span class="pill">${escapeHtml(item.tag || "")}</span>
              <span class="pill">#${idx+1}</span>
            </div>
          </div>
          ${inThumbs}
          <div class="content">
            <div class="name">${escapeHtml(item.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</div>
            ${subLine ? `<div class="sub">${escapeHtml(subLine)}</div>` : ""}
            <div class="desc">${escapeHtml(item.desc || "")}</div>
            <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
              <div class="price">
                <span class="old">${escapeHtml(item.priceOld || "")}</span>
                <span class="new">${escapeHtml(item.priceNew || "")}</span>
              </div>
              <div class="actions ${isAdmin ? "" : "hidden"}">
                <button class="btn secondary" data-move="up" data-id="${escapeHtml(item.id)}" type="button" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—ã—à–µ">‚Üë</button>
                <button class="btn secondary" data-move="down" data-id="${escapeHtml(item.id)}" type="button" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∏–∂–µ">‚Üì</button>
                <button class="btn secondary" data-edit="${escapeHtml(item.id)}" type="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn danger" data-del="${escapeHtml(item.id)}" type="button">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          </div>
        `;

        card.addEventListener("click", (e)=>{
          const t = e.target;
          if(t && (t.closest("button") || t.closest(".actions") || t.closest(".thumb"))) return;
          selectedCardId = item.id;
          render();
        });

        gridEl.appendChild(card);
      }

      bindGridHandlers();
    }

    function bindGridHandlers(){
      // –ì–∞–ª–µ—Ä–µ—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
      function updateGallery(id, dir){
        const el = gridEl.querySelector(`[data-gallery="${CSS.escape(id)}"]`);
        if(!el) return;

        const item = getItemById(id);
        if(!item || !Array.isArray(item.images) || item.images.length < 2) return;

        let i = parseInt(el.getAttribute("data-index") || "0", 10);
        i = (i + dir + item.images.length) % item.images.length;
        el.setAttribute("data-index", String(i));

        const img = el.querySelector("img.photo");
        if(img) img.src = item.images[i];

        el.querySelectorAll(".dot").forEach((d, idx)=> d.classList.toggle("active", idx === i));

        const thumbsWrap = gridEl.querySelector(`[data-thumbs="${CSS.escape(id)}"]`);
        if(thumbsWrap){
          thumbsWrap.querySelectorAll(".in-thumb").forEach(th=>{
            th.classList.toggle("active", th.getAttribute("data-index") === String(i));
          });
        }
      }

      gridEl.querySelectorAll("[data-prev]").forEach(b=>{
        b.addEventListener("click", (e)=>{ e.stopPropagation(); updateGallery(b.getAttribute("data-prev"), -1); });
      });
      gridEl.querySelectorAll("[data-next]").forEach(b=>{
        b.addEventListener("click", (e)=>{ e.stopPropagation(); updateGallery(b.getAttribute("data-next"), +1); });
      });

      // –ú–∏–Ω–∏–∞—Ç—é—Ä—ã: –æ–¥–∏–Ω–∞—Ä–Ω—ã–π —Ç–∞–ø –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ
      gridEl.querySelectorAll("[data-jump]").forEach(th=>{
        th.addEventListener("click", (e)=>{
          e.stopPropagation();
          const id = th.getAttribute("data-jump");
          const idx = parseInt(th.getAttribute("data-index") || "0", 10);
          openLightbox(id, idx);
        });
      });

      // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø–æ –æ–¥–∏–Ω–∞—Ä–Ω–æ–º—É —Ç–∞–ø—É/–∫–ª–∏–∫—É –ø–æ –±–æ–ª—å—à–æ–º—É —Ñ–æ—Ç–æ
      gridEl.querySelectorAll("[data-imgwrap]").forEach(w=>{
        w.addEventListener("click", (e)=>{
          const t = e.target;
          if(t && t.closest && t.closest("button")) return;
          e.stopPropagation();
          const id = w.getAttribute("data-imgwrap");
          const idx = parseInt(w.getAttribute("data-index") || "0", 10);
          openLightbox(id, idx);
        });
      });

      if(!isAdmin) return;

      // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ ‚Üë ‚Üì
      gridEl.querySelectorAll("[data-move]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const dir = btn.getAttribute("data-move");
          const id = btn.getAttribute("data-id");
          const list = getActiveList();
          const i = list.findIndex(x => x.id === id);
          if(i < 0) return;
          const j = dir === "up" ? i-1 : i+1;
          if(j < 0 || j >= list.length) return;
          const tmp = list[i];
          list[i] = list[j];
          list[j] = tmp;
          setActiveList(list);
          saveState();
          render();
        });
      });

      // –£–¥–∞–ª–µ–Ω–∏–µ
      gridEl.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const id = btn.getAttribute("data-del");
          const list = getActiveList().filter(x => x.id !== id);
          setActiveList(list);
          if(selectedCardId === id) selectedCardId = null;
          saveState();
          render();
        });
      });

      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      gridEl.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const id = btn.getAttribute("data-edit");
          const item = getItemById(id);
          if(!item) return;

          editingId = id;
          editImages = Array.isArray(item.images) ? [...item.images].slice(0,MAX_PHOTOS) : [];

          const meta = [item.name, item.color, item.finish].filter(Boolean).join(" ‚Ä¢ ");
          editTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${meta || ""}`;

          editName.value = item.name || "";
          editColor.value = item.color || "";
          editFinish.value = item.finish || "";
          editDesc.value = item.desc || "";
          editPriceNew.value = item.priceNew || "";
          editPriceOld.value = item.priceOld || "";

          editFilesEl.value = "";
          refreshEditThumbs();
          editDialog.showModal();
        });
      });

      // Drag&Drop (–ü–ö)
      gridEl.querySelectorAll("article.card[draggable='true']").forEach(cardEl=>{
        cardEl.addEventListener("dragstart", (e)=>{
          dragFromId = cardEl.dataset.dragId || null;
          try{ e.dataTransfer.setData("text/plain", dragFromId || ""); }catch(_){ }
          e.dataTransfer.effectAllowed = "move";
        });

        cardEl.addEventListener("dragover", (e)=>{
          if(!dragFromId) return;
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
          cardEl.classList.add("selected");
        });

        cardEl.addEventListener("dragleave", ()=>{
          cardEl.classList.remove("selected");
        });

        cardEl.addEventListener("drop", (e)=>{
          e.preventDefault();
          cardEl.classList.remove("selected");
          const toId = cardEl.dataset.dragId || null;
          const fromId = dragFromId || (function(){ try{ return e.dataTransfer.getData("text/plain"); }catch(_){ return null; } })();
          dragFromId = null;
          if(!fromId || !toId || fromId === toId) return;

          const list = getActiveList();
          const fromIdx = list.findIndex(x => x.id === fromId);
          const toIdx = list.findIndex(x => x.id === toId);
          if(fromIdx < 0 || toIdx < 0) return;

          const [moved] = list.splice(fromIdx, 1);
          const insertAt = fromIdx < toIdx ? toIdx - 1 : toIdx;
          list.splice(insertAt, 0, moved);
          setActiveList(list);
          saveState();
          render();
        });
      });
    }

    // tabs
    tabsEl.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        activeTab = btn.dataset.tab;
        selectedCardId = null;
        saveState();
        render();
      });
    });

    // admin login/logout
    adminBtn.addEventListener("click", ()=>{
      if(isAdmin){
        isAdmin = false;
        sessionStorage.removeItem("doors_admin");
        adminBtnVisible = false;
        render();
        return;
      }

      const p = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
      if(p === null) return;
      if(p === ADMIN_PASSWORD){
        isAdmin = true;
        sessionStorage.setItem("doors_admin", "1");
        render();
      }else{
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
      }
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω¬ª: 7 –±—ã—Å—Ç—Ä—ã—Ö —Ç–∞–ø–æ–≤ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É (–∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã)
    let titleTapCount = 0;
    let titleTapTimer = null;

    function revealAdminButton(){
      adminBtnVisible = true;
      render();
    }

    siteTitle.addEventListener("click", ()=>{
      if(adminBtnVisible || isAdmin) return;
      titleTapCount++;
      clearTimeout(titleTapTimer);
      titleTapTimer = setTimeout(()=>{ titleTapCount = 0; }, 3000);
      if(titleTapCount >= 7){
        titleTapCount = 0;
        revealAdminButton();
      }
    });

    // –°–Ω—è—Ç–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª–∏–∫–æ–º –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É (–æ–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å)
    document.addEventListener("click", (ev)=>{
      if(lightbox && !lightbox.classList.contains("hidden")) return;
      const within = ev.target && ev.target.closest && ev.target.closest(".card");
      if(!within && selectedCardId !== null){
        selectedCardId = null;
        render();
      }
    });

    // add images
    addFilesEl.addEventListener("change", async ()=>{
      if(!isAdmin) return;
      try{
        const remaining = MAX_PHOTOS - pendingAddImages.length;
        const { out, skipped } = await readFilesCompressedWithLimit(addFilesEl.files, remaining);
        pendingAddImages.push(...out);
        pendingAddImages = pendingAddImages.slice(0, MAX_PHOTOS);
        addFilesEl.value = "";
        if(skipped > 0) alert(`–ú–æ–∂–Ω–æ –º–∞–∫—Å–∏–º—É–º ${MAX_PHOTOS} —Ñ–æ—Ç–æ. –õ–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã (${skipped}) –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.`);
        render();
      }catch(_){
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å/—Å–∂–∞—Ç—å —Ñ–æ—Ç–æ");
      }
    });

    // add item
    addBtn.addEventListener("click", ()=>{
      if(!isAdmin){
        alert("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
        return;
      }

      const name = nameEl.value.trim();
      const color = colorEl.value.trim();
      const finish = finishEl.value.trim();
      const priceNew = priceNewEl.value.trim();
      const priceOld = priceOldEl.value.trim();
      const desc = descEl.value.trim();
      const images = [...pendingAddImages].slice(0, MAX_PHOTOS);

      if(!name){
        nameEl.focus();
        nameEl.style.boxShadow = "0 0 0 2px rgba(255,90,106,.35)";
        setTimeout(()=> nameEl.style.boxShadow = "", 700);
        return;
      }

      const newItem = {
        id: uid(),
        name,
        color,
        finish,
        priceNew,
        priceOld,
        desc,
        tag: activeTab === "interior" ? "–ú–µ–∂–∫–æ–º–Ω." : "–í—Ö–æ–¥–Ω–∞—è",
        images
      };

      const list = getActiveList();
      list.unshift(newItem);
      setActiveList(list);

      nameEl.value = "";
      colorEl.value = "";
      finishEl.value = "";
      priceNewEl.value = "";
      priceOldEl.value = "";
      descEl.value = "";
      pendingAddImages = [];
      searchEl.value = "";
      searchPublicEl.value = "";

      saveState();
      render();
    });

    // search
    searchEl.addEventListener("input", render);
    searchPublicEl.addEventListener("input", render);

    // reset / clear
    resetBtn.addEventListener("click", ()=>{
      if(!isAdmin){
        alert("–°–±—Ä–æ—Å –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
        return;
      }
      const fresh = defaultState();
      fresh.activeTab = activeTab;
      state = fresh;
      saveState();
      pendingAddImages = [];
      selectedCardId = null;
      render();
    });

    clearBtn.addEventListener("click", ()=>{
      if(!isAdmin){
        alert("–û—á–∏—Å—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
        return;
      }
      setActiveList([]);
      saveState();
      selectedCardId = null;
      render();
    });

    // edit dialog
    editClose.addEventListener("click", ()=> editDialog.close());
    editCancel.addEventListener("click", ()=> editDialog.close());

    editDialog.addEventListener("close", ()=>{
      editingId = null;
      editImages = [];
      editThumbsEl.innerHTML = "";
      editFilesEl.value = "";
    });

    editFilesEl.addEventListener("change", async ()=>{
      if(!isAdmin) return;
      try{
        const remaining = MAX_PHOTOS - editImages.length;
        const { out, skipped } = await readFilesCompressedWithLimit(editFilesEl.files, remaining);
        editImages.push(...out);
        editImages = editImages.slice(0, MAX_PHOTOS);
        editFilesEl.value = "";
        if(skipped > 0) alert(`–ú–æ–∂–Ω–æ –º–∞–∫—Å–∏–º—É–º ${MAX_PHOTOS} —Ñ–æ—Ç–æ. –õ–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã (${skipped}) –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.`);
        refreshEditThumbs();
      }catch(_){
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å/—Å–∂–∞—Ç—å —Ñ–æ—Ç–æ");
      }
    });

    editSave.addEventListener("click", ()=>{
      if(!isAdmin || !editingId) return;

      const item = getItemById(editingId);
      if(!item) return;

      item.name = (editName.value || "").trim();
      item.color = (editColor.value || "").trim();
      item.finish = (editFinish.value || "").trim();
      item.desc = (editDesc.value || "").trim();
      item.priceNew = (editPriceNew.value || "").trim();
      item.priceOld = (editPriceOld.value || "").trim();
      item.images = [...editImages].slice(0, MAX_PHOTOS);

      saveState();
      editDialog.close();
      render();
    });

    // ---- Mini tests (console) ----
    function assert(cond, msg){
      if(!cond) throw new Error("TEST FAIL: " + msg);
    }

    function runTests(){
      // test 1: clamp
      const clamped = ["1","2","3","4","5","6"].slice(0, MAX_PHOTOS);
      assert(clamped.length === MAX_PHOTOS, "Clamp to MAX_PHOTOS");

      // test 2: makeCover
      const cov = makeCover(["a","b","c"], 2);
      assert(cov[0] === "c" && cov.length === 3, "makeCover moves selected to front");

      // test 3: search fields include color/finish
      const itm = { name:"A", color:"–ë–µ–ª—ã–π", finish:"–≠–∫–æ—à–ø–æ–Ω", desc:"", priceNew:"", priceOld:"" };
      const q = "—ç–∫–æ—à";
      const ok = (itm.name+" "+itm.color+" "+itm.finish+" "+itm.desc+" "+itm.priceNew+" "+itm.priceOld).toLowerCase().includes(q);
      assert(ok === true, "Search matches finish");

      // test 4: swap
      const a = [{id:"1"},{id:"2"},{id:"3"}];
      const i=1,j=2; const t=a[i]; a[i]=a[j]; a[j]=t;
      assert(a.map(x=>x.id).join(",") === "1,3,2", "Swap move works");

      // test 5: uid non-empty
      assert(typeof uid() === "string" && uid().length > 6, "uid() returns a string");

      console.log("‚úÖ tests ok");
    }

    // init
    activeTab = state.activeTab || "interior";
    render();
    try{ runTests(); }catch(e){ console.warn(e); }
  </script>
</body>
</html>
